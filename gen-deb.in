#!/bin/sh

if [ ! "@OPENTREA_UNDEFINED_VARIABLE@" = "" ]; then
	echo "Please run gen-deb generated by cmake inside the build directory"
	exit 1
fi

if [ -d package-deb ]; then
	echo "package-deb already exists: It will be replaced"
	rm -rf package-deb
fi

export DEBIAN=package-deb/opentrea/DEBIAN
export RULES=package-deb/opentrea/etc/udev/rules.d
export BIN=package-deb/opentrea/usr/bin
export ASSETS=package-deb/opentrea/etc/opentrea

mkdir -p $DEBIAN
mkdir -p $RULES
mkdir -p $BIN
mkdir -p $ASSETS

if [ ! -f opentrea ]; then
	echo "Error: Can't find opentrea"
	exit 1
fi

cat << 'EOF' > $DEBIAN/conffiles
/etc/opentrea/opentrea.conf
/etc/opentrea/apps_linux.json
EOF

cat << 'EOF' > $DEBIAN/control
Package: opentrea
Architecture: amd64
Maintainer: @loki
Priority: optional
Version: 0.2.1
Depends: libssl1.1, libavdevice58, libboost-thread1.71.0, libboost-filesystem1.71.0, libboost-log1.71.0, libpulse0, libopus0, libxcb-shm0, libxcb-xfixes0
Description: Gamestream host for Moonlight
EOF

cat << 'EOF' > $DEBIAN/postinst
#!/bin/sh

export GROUP_INPUT=input

if [ -f /etc/group ]; then
        if ! grep -q $GROUP_INPUT /etc/group; then
                echo "Creating group $GROUP_INPUT"

                groupadd $GROUP_INPUT
        fi
else
        echo "Warning: /etc/group not found"
fi
EOF

cat << 'EOF' > $RULES/85-opentrea-rules.rules
KERNEL=="uinput", GROUP="input", MODE="0660"
EOF

cp opentrea $BIN/opentrea
cp @CMAKE_CURRENT_SOURCE_DIR@/assets/apps_linux.json $ASSETS/apps_linux.json
cp @CMAKE_CURRENT_SOURCE_DIR@/assets/opentrea.conf $ASSETS/opentrea.conf

chmod 755 $DEBIAN/postinst
chmod 755 $BIN/opentrea
chmod 644 $RULES/85-opentrea-rules.rules

cd package-deb
if fakeroot dpkg-deb --build opentrea; then
	echo "generated debian package: @CMAKE_CURRENT_BINARY_DIR@/package-deb/opentrea.deb"
fi
cd ..

